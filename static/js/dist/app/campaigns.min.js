var labels={"In progress":"label-primary",Queued:"label-info",Completed:"label-success","Emails Sent":"label-success",Error:"label-danger"},campaigns=[],campaign={};function launch(){Swal.fire({title:"Are you sure?",text:"This will schedule the campaign to be launched.",type:"question",animation:!1,showCancelButton:!0,confirmButtonText:"Launch",confirmButtonColor:"#428bca",reverseButtons:!0,allowOutsideClick:!1,showLoaderOnConfirm:!0,preConfirm:function(){return new Promise((function(resolve,reject){groups=[],$("#users").select2("data").forEach((function(group){groups.push({name:group.text})}));var send_by_date=$("#send_by_date").val();""!=send_by_date&&(send_by_date=moment(send_by_date,"MMMM Do YYYY, h:mm a").utc().format()),campaign={name:$("#name").val(),template:{name:$("#template").select2("data")[0].text},url:$("#url").val(),anchor:$("#anchor").val(),page:{name:$("#page").select2("data")[0].text},smtp:{name:$("#profile").select2("data")[0].text},launch_date:moment($("#launch_date").val(),"MMMM Do YYYY, h:mm a").utc().format(),send_by_date:send_by_date||null,groups:groups},api.campaigns.post(campaign).success((function(data){resolve(),campaign=data})).error((function(data){$("#modal\\.flashes").empty().append('<div style="text-align:center" class="alert alert-danger">            <i class="fa fa-exclamation-circle"></i> '+data.responseJSON.message+"</div>"),Swal.close()}))}))}}).then((function(result){result.value&&Swal.fire("Campaign Scheduled!","This campaign has been scheduled for launch!","success"),$('button:contains("OK")').on("click",(function(){window.location="/campaigns/"+campaign.id.toString()}))}))}function sendTestEmail(){var test_email_request={template:{name:$("#template").select2("data")[0].text},first_name:$("input[name=to_first_name]").val(),last_name:$("input[name=to_last_name]").val(),email:$("input[name=to_email]").val(),position:$("input[name=to_position]").val(),url:$("#url").val(),page:{name:$("#page").select2("data")[0].text},smtp:{name:$("#profile").select2("data")[0].text}};btnHtml=$("#sendTestModalSubmit").html(),$("#sendTestModalSubmit").html('<i class="fa fa-spinner fa-spin"></i> Sending'),api.send_test_email(test_email_request).success((function(data){$("#sendTestEmailModal\\.flashes").empty().append('<div style="text-align:center" class="alert alert-success">            <i class="fa fa-check-circle"></i> Email Sent!</div>'),$("#sendTestModalSubmit").html(btnHtml)})).error((function(data){$("#sendTestEmailModal\\.flashes").empty().append('<div style="text-align:center" class="alert alert-danger">            <i class="fa fa-exclamation-circle"></i> '+data.responseJSON.message+"</div>"),$("#sendTestModalSubmit").html(btnHtml)}))}function dismiss(){$("#modal\\.flashes").empty(),$("#name").val(""),$("#template").val("").change(),$("#page").val("").change(),$("#url").val(""),$("#anchor").val(""),$("#profile").val("").change(),$("#users").val("").change(),$("#modal").modal("hide")}function deleteCampaign(idx){Swal.fire({title:"Are you sure?",text:"This will delete the campaign. This can't be undone!",type:"warning",animation:!1,showCancelButton:!0,confirmButtonText:"Delete "+campaigns[idx].name,confirmButtonColor:"#428bca",reverseButtons:!0,allowOutsideClick:!1,preConfirm:function(){return new Promise((function(resolve,reject){api.campaignId.delete(campaigns[idx].id).success((function(msg){resolve()})).error((function(data){reject(data.responseJSON.message)}))}))}}).then((function(result){result.value&&Swal.fire("Campaign Deleted!","This campaign has been deleted!","success"),$('button:contains("OK")').on("click",(function(){location.reload()}))}))}function setupOptions(){api.groups.summary().success((function(summaries){if(groups=summaries.groups,0==groups.length)return modalError("No groups found!"),!1;var group_s2=$.map(groups,(function(obj){return obj.text=obj.name,obj.title=obj.num_targets+" targets",obj}));console.log(group_s2),$("#users.form-control").select2({placeholder:"Select Groups",data:group_s2})})),api.templates.get().success((function(templates){if(0==templates.length)return modalError("No templates found!"),!1;var template_s2=$.map(templates,(function(obj){return obj.text=obj.name,obj})),template_select=$("#template.form-control");template_select.select2({placeholder:"Select a Template",data:template_s2}),1===templates.length&&(template_select.val(template_s2[0].id),template_select.trigger("change.select2"))})),api.pages.get().success((function(pages){if(0==pages.length)return modalError("No pages found!"),!1;var page_s2=$.map(pages,(function(obj){return obj.text=obj.name,obj})),page_select=$("#page.form-control");page_select.select2({placeholder:"Select a Landing Page",data:page_s2}),1===pages.length&&(page_select.val(page_s2[0].id),page_select.trigger("change.select2"))})),api.SMTP.get().success((function(profiles){if(0==profiles.length)return modalError("No profiles found!"),!1;var profile_s2=$.map(profiles,(function(obj){return obj.text=obj.name,obj})),profile_select=$("#profile.form-control");profile_select.select2({placeholder:"Select a Sending Profile",data:profile_s2}).select2("val",profile_s2[0]),1===profiles.length&&(profile_select.val(profile_s2[0].id),profile_select.trigger("change.select2"))}))}function edit(campaign){setupOptions()}function copy(idx){setupOptions(),api.campaignId.get(campaigns[idx].id).success((function(campaign){$("#name").val("Copy of "+campaign.name),campaign.template.id?($("#template").val(campaign.template.id.toString()),$("#template").trigger("change.select2")):($("#template").val("").change(),$("#template").select2({placeholder:campaign.template.name})),campaign.page.id?($("#page").val(campaign.page.id.toString()),$("#page").trigger("change.select2")):($("#page").val("").change(),$("#page").select2({placeholder:campaign.page.name})),campaign.smtp.id?($("#profile").val(campaign.smtp.id.toString()),$("#profile").trigger("change.select2")):($("#profile").val("").change(),$("#profile").select2({placeholder:campaign.smtp.name})),$("#url").val(campaign.url),$("#anchor").val(campaign.anchor)})).error((function(data){$("#modal\\.flashes").empty().append('<div style="text-align:center" class="alert alert-danger">            <i class="fa fa-exclamation-circle"></i> '+data.responseJSON.message+"</div>")}))}function generateKey(){$("#anchor").val(makeid(32))}function makeid(length){for(var result="",characters="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",charactersLength=characters.length,i=0;i<length;i++)result+=characters.charAt(Math.floor(Math.random()*charactersLength));return result}$(document).ready((function(){$("#launch_date").datetimepicker({widgetPositioning:{vertical:"bottom"},showTodayButton:!0,defaultDate:moment(),format:"MMMM Do YYYY, h:mm a"}),$("#send_by_date").datetimepicker({widgetPositioning:{vertical:"bottom"},showTodayButton:!0,useCurrent:!1,format:"MMMM Do YYYY, h:mm a"}),$("#generate_key_btn").click(()=>generateKey()),$(".modal").on("hidden.bs.modal",(function(event){$(this).removeClass("fv-modal-stack"),$("body").data("fv_open_modals",$("body").data("fv_open_modals")-1)})),$(".modal").on("shown.bs.modal",(function(event){void 0===$("body").data("fv_open_modals")&&$("body").data("fv_open_modals",0),$(this).hasClass("fv-modal-stack")||($(this).addClass("fv-modal-stack"),$("body").data("fv_open_modals",$("body").data("fv_open_modals")+1),$(this).css("z-index",1040+10*$("body").data("fv_open_modals")),$(".modal-backdrop").not(".fv-modal-stack").css("z-index",1039+10*$("body").data("fv_open_modals")),$(".modal-backdrop").not("fv-modal-stack").addClass("fv-modal-stack"))})),$(document).on("hidden.bs.modal",".modal",(function(){$(".modal:visible").length&&$(document.body).addClass("modal-open")})),$("#modal").on("hidden.bs.modal",(function(event){dismiss()})),api.campaigns.summary().success((function(data){campaigns=data.campaigns,$("#loading").hide(),campaigns.length>0?($("#campaignTable").show(),$("#campaignTableArchive").show(),activeCampaignsTable=$("#campaignTable").DataTable({columnDefs:[{orderable:!1,targets:"no-sort"}],order:[[1,"desc"]]}),archivedCampaignsTable=$("#campaignTableArchive").DataTable({columnDefs:[{orderable:!1,targets:"no-sort"}],order:[[1,"desc"]]}),rows={active:[],archived:[]},$.each(campaigns,(function(i,campaign){var launchDate;if(label=labels[campaign.status]||"label-default",moment(campaign.launch_date).isAfter(moment()))var quickStats=(launchDate="Scheduled to start: "+moment(campaign.launch_date).format("MMMM Do YYYY, h:mm:ss a"))+"<br><br>Number of recipients: "+campaign.stats.total;else var quickStats=(launchDate="Launch Date: "+moment(campaign.launch_date).format("MMMM Do YYYY, h:mm:ss a"))+"<br><br>Number of recipients: "+campaign.stats.total+"<br><br>Emails opened: "+campaign.stats.opened+"<br><br>Emails clicked: "+campaign.stats.clicked+"<br><br>Submitted Credentials: "+campaign.stats.submitted_data+"<br><br>Errors : "+campaign.stats.error+"<br><br>Reported : "+campaign.stats.email_reported;var row=[escapeHtml(campaign.name),moment(campaign.created_date).format("MMMM Do YYYY, h:mm:ss a"),'<span class="label '+label+'" data-toggle="tooltip" data-placement="right" data-html="true" title="'+quickStats+'">'+campaign.status+"</span>","<div class='pull-right'><a class='btn btn-primary' href='/campaigns/"+campaign.id+"' data-toggle='tooltip' data-placement='left' title='View Results'>                    <i class='fa fa-bar-chart'></i>                    </a>            <span data-toggle='modal' data-backdrop='static' data-target='#modal'><button class='btn btn-primary' data-toggle='tooltip' data-placement='left' title='Copy Campaign' onclick='copy("+i+")'>                    <i class='fa fa-copy'></i>                    </button></span>                    <button class='btn btn-danger' onclick='deleteCampaign("+i+")' data-toggle='tooltip' data-placement='left' title='Delete Campaign'>                    <i class='fa fa-trash-o'></i>                    </button></div>"];"Completed"==campaign.status?rows.archived.push(row):rows.active.push(row)})),activeCampaignsTable.rows.add(rows.active).draw(),archivedCampaignsTable.rows.add(rows.archived).draw(),$('[data-toggle="tooltip"]').tooltip()):$("#emptyMessage").show()})).error((function(){$("#loading").hide(),errorFlash("Error fetching campaigns")})),$.fn.select2.defaults.set("width","100%"),$.fn.select2.defaults.set("dropdownParent",$("#modal_body")),$.fn.select2.defaults.set("theme","bootstrap"),$.fn.select2.defaults.set("sorter",(function(data){return data.sort((function(a,b){return a.text.toLowerCase()>b.text.toLowerCase()?1:a.text.toLowerCase()<b.text.toLowerCase()?-1:0}))}))}));